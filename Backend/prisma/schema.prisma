// ================================================================
// FIXED PRISMA SCHEMA - Multi-Group Support
// Student can be in multiple groups (via Enrollment.group_id)
// ================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ================================================================
// STUDENT - No direct group_id
// Groups accessed via enrollments
// ================================================================
model Student {
  student_id      String        @id @default(uuid()) @db.Uuid
  first_name      String        @db.VarChar(100)
  last_name       String        @db.VarChar(100)
  date_of_birth   DateTime?
  gender          Gender?
  user_id         String        @unique @db.Uuid
  phone_number    String?       @db.VarChar(35)
  email           String?       @db.VarChar(100)
  secondary_email String?       @db.VarChar(100)
  address         String?
  nationality     String?       @db.VarChar(50)
  language        String?
  avatar_url      String?
  education_level String?       @db.VarChar(100)
  study_location  String?       @db.VarChar(100)
  status          StudentStatus @default(ACTIVE)
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  // ❌ REMOVED: group_id String? @db.Uuid
  // ❌ REMOVED: group Group? @relation(fields: [group_id], references: [group_id])

  // Relations
  attendance  Attendance[]
  documents   Document[]          @relation("StudentDocuments")
  enrollments Enrollment[] // ✅ Access groups via this
  fees        Fee[]
  results     Result[]
  permissions StudentPermission[]
  user        User?

  @@map("Student")
}

// ================================================================
// TEACHER
// ================================================================
model Teacher {
  teacher_id   String   @id @default(uuid()) @db.Uuid
  first_name   String   @db.VarChar(100)
  last_name    String   @db.VarChar(100)
  email        String?  @db.VarChar(100)
  phone_number String?  @db.VarChar(35)
  created_at   DateTime @default(now())

  // Relations
  groups Group[]
  user   User?

  @@map("Teacher")
}

// ================================================================
// COURSE
// ================================================================
model Course {
  course_id   String   @id @default(uuid()) @db.Uuid
  course_code String?  @unique @db.VarChar(20)
  course_name String   @db.VarChar(100)
  credits     Int?
  fee_amount  Decimal? @default(1000) @db.Decimal(10, 2)

  profile       CourseProfile?
  enrollments   Enrollment[]
  exams         Exam[]
  groups        Group[]
  notifications Notification[]

  @@map("Course")
}

model CourseProfile {
  profile_id String @id @default(uuid()) @db.Uuid
  course_id  String @unique @db.Uuid

  title_ar       String? @db.VarChar(200)
  description    String? @db.Text
  description_ar String? @db.Text

  language   String? @db.VarChar(50)
  level      String? @db.VarChar(20)
  flag_emoji String? @db.VarChar(10)

  price    Decimal? @default(0) @db.Decimal(10, 2)
  currency String?  @default("DZD") @db.VarChar(10)

  session_name String?   @db.VarChar(100)
  start_date   DateTime?
  end_date     DateTime?

  registration_open Boolean @default(true)
  is_published      Boolean @default(false)
  image_url         String?
  image_public_id   String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  course  Course          @relation(fields: [course_id], references: [course_id], onDelete: Cascade)
  pricing CoursePricing[] // ← الإضافة الجديدة

  @@map("CourseProfile")
}

model CoursePricing {
  pricing_id String @id @default(uuid()) @db.Uuid
  profile_id String @db.Uuid

  status_fr String  @db.VarChar(200) // "Étudiant(e)"
  status_ar String? @db.VarChar(200) // "طالب"
  status_en String? @db.VarChar(200) // "Student"

  price    Decimal @default(0) @db.Decimal(10, 2)
  currency String  @default("DA") @db.VarChar(10)
  discount String? @db.VarChar(100) // "Aucune", "50%"

  sort_order Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  profile CourseProfile @relation(fields: [profile_id], references: [profile_id], onDelete: Cascade)

  enrollments Enrollment[] // ✅ جديد (back-relation)   

  @@map("CoursePricing")
}

// ================================================================
// DEPARTMENT
// ================================================================
model Department {
  department_id String   @id @default(uuid()) @db.Uuid
  name          String   @unique @db.VarChar(100)
  description   String?
  created_at    DateTime @default(now())

  // Relations
  groups Group[]

  @@map("Department")
}

// ================================================================
// GROUP - No direct students relation
// Students accessed via enrollments
// ================================================================
model Group {
  group_id      String      @id @default(uuid()) @db.Uuid
  name          String
  department_id String?     @db.Uuid
  course_id     String      @db.Uuid
  max_students  Int         @default(25)
  status        GroupStatus @default(OPEN)
  teacher_id    String?     @db.Uuid
  level         Level

  enrollments   Enrollment[]
  sessions      Session[]
  course        Course         @relation(fields: [course_id], references: [course_id])
  department    Department?    @relation(fields: [department_id], references: [department_id])
  teacher       Teacher?       @relation(fields: [teacher_id], references: [teacher_id])
  notifications Notification[]

  @@map("Group")
}

// ================================================================
// ENROLLMENT - Core of multi-group system
// Each enrollment can have its own group_id
// ================================================================
model Enrollment {
  enrollment_id       String             @id @default(uuid()) @db.Uuid
  student_id          String             @db.Uuid
  course_id           String             @db.Uuid
  group_id            String?            @db.Uuid // ✅ Group stored here
  enrollment_date     DateTime           @default(now())
  level               Level?
  start_date          DateTime?
  end_date            DateTime?
  registration_status RegistrationStatus @default(PENDING)

  pricing_id String?        @db.Uuid // ✅ جديد
  pricing    CoursePricing? @relation(fields: [pricing_id], references: [pricing_id], onDelete: SetNull) // ✅ جديد

  // Relations
  course  Course                @relation(fields: [course_id], references: [course_id])
  group   Group?                @relation(fields: [group_id], references: [group_id]) // ✅ Direct relation
  student Student               @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  fees    Fee[]
  history RegistrationHistory[]

  // ✅ Ensures one enrollment per student per course
  @@unique([student_id, course_id])
  @@map("Enrollment")
}

// ================================================================
// SESSION
// ================================================================
model Session {
  session_id   String   @id @default(uuid()) @db.Uuid
  group_id     String   @db.Uuid
  session_date DateTime
  end_time     DateTime?
  topic        String?
  room_id      String?  @db.Uuid

  // Relations
  attendance Attendance[]
  group      Group        @relation(fields: [group_id], references: [group_id])
  room       Room?        @relation(fields: [room_id], references: [room_id])

  @@map("Session")
}

model Room {
  room_id    String   @id @default(uuid()) @db.Uuid
  name       String   @unique
  capacity   Int      @default(30)
  location   String?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())

  sessions Session[]

  @@map("Room")
}

// ================================================================
// ATTENDANCE
// ================================================================
model Attendance {
  attendance_id String           @id @default(uuid()) @db.Uuid
  session_id    String           @db.Uuid
  student_id    String           @db.Uuid
  status        AttendanceStatus

  // Relations
  session Session @relation(fields: [session_id], references: [session_id], onDelete: Restrict)
  student Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)

  @@unique([session_id, student_id])
  @@map("Attendance")
}

// ================================================================
// EXAM
// ================================================================
model Exam {
  exam_id   String   @id @default(uuid()) @db.Uuid
  course_id String   @db.Uuid
  exam_name String?
  exam_date DateTime
  max_marks Int

  // Relations
  course  Course   @relation(fields: [course_id], references: [course_id])
  results Result[]

  @@map("Exam")
}

// ================================================================
// RESULT
// ================================================================
model Result {
  result_id      String  @id @default(uuid()) @db.Uuid
  exam_id        String  @db.Uuid
  student_id     String  @db.Uuid
  marks_obtained Int
  grade          String?

  // Relations
  exam    Exam    @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)
  student Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)

  @@unique([exam_id, student_id])
  @@map("Result")
}

// ================================================================
// FEE
// ================================================================
model Fee {
  fee_id         String    @id @default(uuid()) @db.Uuid
  student_id     String    @db.Uuid
  enrollment_id  String?   @db.Uuid
  amount         Decimal   @db.Decimal(10, 2)
  due_date       DateTime
  status         FeeStatus @default(UNPAID)
  payment_method String?   @db.VarChar(30)
  reference_code String?   @db.VarChar(100)
  paid_at        DateTime?

  // Relations
  enrollment Enrollment? @relation(fields: [enrollment_id], references: [enrollment_id])
  student    Student     @relation(fields: [student_id], references: [student_id], onDelete: Cascade)

  @@map("Fee")
}

// ================================================================
// DOCUMENT
// ================================================================
model Document {
  document_id String         @id @default(uuid())
  student_id  String         @db.Uuid
  type        String
  file_path   String
  public_id   String?
  status      DocumentStatus @default(PENDING)
  reviewed_at DateTime?
  reviewed_by String?        @db.Uuid
  uploaded_at DateTime       @default(now())

  // Relations
  student Student @relation("StudentDocuments", fields: [student_id], references: [student_id])

  @@map("Document")
}

// ================================================================
// PERMISSION
// ================================================================
model Permission {
  permission_id String  @id @default(uuid()) @db.Uuid
  name          String  @unique
  description   String?

  // Relations
  students StudentPermission[]

  @@map("Permission")
}

// ================================================================
// STUDENT PERMISSION (Junction Table)
// ================================================================
model StudentPermission {
  student_id    String @db.Uuid
  permission_id String @db.Uuid

  // Relations
  permission Permission @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade)
  student    Student    @relation(fields: [student_id], references: [student_id], onDelete: Cascade)

  @@id([student_id, permission_id])
  @@map("StudentPermission")
}

// ================================================================
// REGISTRATION HISTORY
// ================================================================
model RegistrationHistory {
  history_id    String             @id @default(uuid()) @db.Uuid
  enrollment_id String             @db.Uuid
  old_status    RegistrationStatus
  new_status    RegistrationStatus
  changed_at    DateTime           @default(now())
  changed_by    String?            @db.Uuid

  // Relations
  enrollment Enrollment @relation(fields: [enrollment_id], references: [enrollment_id], onDelete: Cascade)

  @@map("RegistrationHistory")
}

// ================================================================
// USER
// ================================================================
model User {
  user_id       String   @id @default(uuid()) @db.Uuid
  email         String   @unique @db.VarChar(100)
  password      String?
  role          UserRole @default(STUDENT)
  is_active     Boolean  @default(true)
  google_id     String?  @unique
  google_email  String?
  google_avatar String?
  student_id    String?  @unique @db.Uuid
  teacher_id    String?  @unique @db.Uuid
  created_at    DateTime @default(now())

  refresh_tokens RefreshToken[]
  student        Student?                @relation(fields: [student_id], references: [student_id])
  teacher        Teacher?                @relation(fields: [teacher_id], references: [teacher_id])
  notifications  NotificationRecipient[]

  @@map("User")
}

// ================================================================
// REFRESH TOKEN
// ================================================================
model RefreshToken {
  token_id   String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@map("RefreshToken")
}

model Announcement {
  announcement_id String @id @default(uuid())

  title      String
  title_ar   String?
  content    String  @db.Text
  content_ar String? @db.Text
  excerpt    String?
  excerpt_ar String?

  category String?

  image_url       String?
  image_public_id String?

  is_published Boolean   @default(false)
  published_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("announcements")
}

model Notification {
  notification_id String @id @default(uuid()) @db.Uuid

  // Content
  title      String  @db.VarChar(200)
  title_ar   String? @db.VarChar(200)
  message    String  @db.Text
  message_ar String? @db.Text

  // Targeting
  target_type NotificationTarget // ALL_STUDENTS, ALL_TEACHERS, SPECIFIC_STUDENTS, SPECIFIC_TEACHERS, GROUP, COURSE

  // Optional filters (used based on target_type)
  course_id String? @db.Uuid
  group_id  String? @db.Uuid

  // Meta
  priority   NotificationPriority @default(NORMAL)
  created_by String?              @db.Uuid
  created_at DateTime             @default(now())

  // Relations
  course     Course?                 @relation(fields: [course_id], references: [course_id], onDelete: SetNull)
  group      Group?                  @relation(fields: [group_id], references: [group_id], onDelete: SetNull)
  recipients NotificationRecipient[]

  @@map("Notification")
}

// ================================================================
// NOTIFICATION RECIPIENT - Track who received & read
// ================================================================
model NotificationRecipient {
  recipient_id    String    @id @default(uuid()) @db.Uuid
  notification_id String    @db.Uuid
  user_id         String    @db.Uuid
  is_read         Boolean   @default(false)
  read_at         DateTime?

  // Relations
  notification Notification @relation(fields: [notification_id], references: [notification_id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([notification_id, user_id])
  @@index([user_id, is_read])
  @@map("NotificationRecipient")
}

// ================================================================
// NEW ENUMS
// ================================================================
enum NotificationTarget {
  ALL_STUDENTS
  ALL_TEACHERS
  SPECIFIC_STUDENTS
  SPECIFIC_TEACHERS
  GROUP // All students in a specific group
  COURSE // All students enrolled in a course
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ================================================================
// ENUMS
// ================================================================

enum StudentStatus {
  ACTIVE
  INACTIVE
}

enum GroupStatus {
  OPEN
  FULL
  FINISHED
}

enum UserRole {
  ADMIN
  STUDENT
  TEACHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum FeeStatus {
  PAID
  UNPAID
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum RegistrationStatus {
  PENDING
  VALIDATED
  REJECTED
  PAID
  FINISHED
}

enum Level {
  A1
  A2
  B1
  B2
  C1
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}
